<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP 監控系統 - 優化版</title>
    <link rel="prefetch" href="/api/services/paginated">
    <style>
        /* CSS 變量 - 支援 Dark Mode */
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --header-bg: linear-gradient(135deg, #2c3e50, #3498db);
            --card-bg: rgba(255,255,255,0.95);
            --card-border: rgba(255,255,255,0.2);
            --text-color: #2c3e50;
            --text-light: #6c757d;
            --metric-bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            --metric-hover: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            --metric-border: rgba(52, 152, 219, 0.1);
            --metric-border-hover: rgba(52, 152, 219, 0.3);
            --shadow: rgba(0,0,0,0.12);
            --shadow-hover: rgba(0,0,0,0.2);
            --border-color: #f8f9fa;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
        }

        /* Dark Mode 變量 */
        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --header-bg: linear-gradient(135deg, #1a252f, #2c3e50);
            --card-bg: rgba(30,30,30,0.95);
            --card-border: rgba(255,255,255,0.1);
            --text-color: #e8eaed;
            --text-light: #9aa0a6;
            --metric-bg: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            --metric-hover: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            --metric-border: rgba(74, 85, 104, 0.3);
            --metric-border-hover: rgba(74, 85, 104, 0.5);
            --shadow: rgba(0,0,0,0.3);
            --shadow-hover: rgba(0,0,0,0.5);
            --border-color: #4a5568;
            --accent-color: #60a5fa;
            --accent-hover: #3b82f6;
        }

        /* 基本樣式 - 優化版 */
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
            margin: 0; padding: 20px; 
            background: var(--bg-gradient);
            min-height: 100vh;
            line-height: 1.5;
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .header { 
            background: var(--header-bg);
            color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px;
            box-shadow: 0 8px 32px var(--shadow-hover);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .header h1 {
            margin: 0 0 8px 0;
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
            font-weight: 300;
        }
        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
            gap: 24px; 
        }
        .card { 
            background: var(--card-bg); 
            padding: 24px; 
            border-radius: 16px; 
            box-shadow: 0 8px 32px var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-hover));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 16px 48px var(--shadow-hover);
        }
        .card:hover::before {
            opacity: 1;
        }
        .card h3 { 
            margin-top: 0; 
            margin-bottom: 16px; 
            color: var(--text-color); 
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
        }
        .metric { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin: 10px 0; 
            padding: 12px 16px; 
            border-radius: 12px;
            background: var(--metric-bg);
            border: 1px solid var(--metric-border);
            font-size: 15px;
            line-height: 1.5;
            transition: all 0.2s ease;
            color: var(--text-color);
        }
        .metric:hover {
            background: var(--metric-hover);
            border-color: var(--metric-border-hover);
            transform: translateX(4px);
        }
        .metric-label {
            color: var(--text-light);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .metric-label::before {
            content: '●';
            color: #3498db;
            font-size: 12px;
        }
        .metric-value {
            font-weight: 700;
            color: #2c3e50;
            white-space: nowrap;
            min-width: fit-content;
            background: linear-gradient(135deg, #3498db, #2980b9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .refresh-btn { 
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white; border: none; padding: 12px 24px; 
            border-radius: 10px; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
            position: relative;
            overflow: hidden;
        }
        .refresh-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
            background: linear-gradient(135deg, var(--accent-hover), var(--accent-color));
        }
        .refresh-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
        }
        
        /* Dark Mode Toggle 按鈕 */
        .theme-toggle {
            background: var(--card-bg);
            color: var(--text-color);
            border: 2px solid var(--accent-color);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
        }
        .theme-toggle:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.05);
        }
        .theme-toggle:active {
            transform: scale(0.95);
        }
        
        /* Header 內容區域 */
        .header-content {
            flex: 1;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .loading { 
            text-align: center; 
            color: var(--text-light);
            display: flex; 
            align-items: center; 
            justify-content: center;
            min-height: 120px;
            font-size: 16px;
            font-weight: 600;
            flex-direction: column;
            gap: 20px;
        }
        .loading::after {
            content: '';
            width: 32px; 
            height: 32px;
            border: 3px solid rgba(52, 152, 219, 0.1);
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 數據載入骨架屏 */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            height: 20px;
            margin: 10px 0;
        }
        .skeleton.wide { width: 100%; }
        .skeleton.medium { width: 60%; }
        .skeleton.narrow { width: 40%; }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* 虛擬滾動容器 */
        .virtual-scroll-container {
            height: 400px;
            overflow-y: auto;
            border: 2px solid rgba(52, 152, 219, 0.1);
            border-radius: 16px;
            position: relative;
            background: rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
        }
        .virtual-scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .virtual-scroll-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }
        .virtual-scroll-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 4px;
        }
        .virtual-scroll-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2980b9, #3498db);
        }
        .virtual-scroll-content {
            position: relative;
        }
        .virtual-item {
            padding: 18px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 110px;
            min-height: 110px;
            max-height: 110px;
            font-size: 14px;
            line-height: 1.5;
            box-sizing: border-box;
            overflow: hidden;
            background: rgba(255,255,255,0.8);
            margin: 2px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .virtual-item:hover {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.05) 0%, rgba(46, 204, 113, 0.05) 100%);
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border-color: rgba(52, 152, 219, 0.2);
        }
        .virtual-item-left {
            flex: 1;
            padding-right: 15px;
        }
        .virtual-item-name {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
            line-height: 1.4;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .virtual-item-name::before {
            content: '⚙️';
            font-size: 14px;
        }
        .virtual-item-details {
            font-size: 13px;
            color: #6c757d;
            display: flex;
            flex-direction: column;
            gap: 4px;
            line-height: 1.3;
        }
        .virtual-item-details div {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .virtual-item-right {
            text-align: right;
            min-width: 80px;
        }
        
        /* 懶載入圖表容器 */
        .lazy-chart {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--metric-bg);
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid var(--metric-border);
        }
        .chart-placeholder {
            color: var(--text-light);
            font-style: italic;
        }
        
        /* 優化的表格樣式 */
        .optimized-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .optimized-table th, .optimized-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .optimized-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        /* 分頁控制 */
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 18px 0;
            flex-wrap: wrap;
            font-size: 14px;
        }
        .pagination-controls label {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #495057;
            font-weight: 500;
        }
        .pagination-controls select {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }
        .page-info {
            font-size: 13px;
            color: #6c757d;
            font-weight: 500;
        }
        .page-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .page-btn:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #3498db;
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* 健康度評分樣式 */
        .health-score {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
            padding: 18px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .health-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: white;
            font-size: 1.4rem;
            position: relative;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .health-circle::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            padding: 3px;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
        }
        .health-excellent { 
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
        }
        .health-good { 
            background: linear-gradient(135deg, #3498db, #5dade2);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }
        .health-warning { 
            background: linear-gradient(135deg, #f39c12, #f4d03f);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.3);
        }
        .health-critical { 
            background: linear-gradient(135deg, #e74c3c, #ec7063);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
        }
        
        .health-details {
            flex: 1;
        }
        .health-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .health-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .health-metric-label {
            color: var(--text-light);
        }
        .health-metric-value {
            color: var(--text-color);
            font-weight: 700;
        }
        
        /* 警報樣式 */
        .alert-item {
            padding: 14px 18px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 6px solid;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .alert-item:hover {
            transform: translateX(4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .alert-critical {
            background: linear-gradient(135deg, #fdf2f2 0%, #faddd7 100%);
            border-color: #e74c3c;
            color: #c0392b;
        }
        .alert-warning {
            background: linear-gradient(135deg, #fef9e7 0%, #fef5cd 100%);
            border-color: #f39c12;
            color: #d68910;
        }
        .alert-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .alert-title::before {
            content: '⚠️';
            font-size: 16px;
        }
        .alert-time {
            font-size: 12px;
            opacity: 0.8;
            font-weight: 500;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        /* 日誌樣式 */
        .log-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .log-controls select {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .log-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }
        .log-debug { color: #6c757d; }
        .log-timestamp {
            color: #6c757d;
            margin-right: 10px;
        }
        
        /* 服務控制按鈕 */
        .service-controls {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .control-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .control-btn:hover {
            transform: translateY(-1px);
        }
        .btn-restart { background: #3498db; color: white; }
        .btn-stop { background: #e74c3c; color: white; }
        .btn-start { background: #27ae60; color: white; }
        .btn-terminate { background: #8e44ad; color: white; }
        
        /* 模態對話框樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: var(--card-bg);
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            color: var(--text-color);
            border: 1px solid var(--card-border);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #6c757d;
        }
        .close:hover {
            color: #495057;
        }
        .threshold-input {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        .threshold-input input {
            width: 80px;
            padding: 6px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        
        /* 響應式優化 */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .dashboard { grid-template-columns: 1fr; gap: 18px; }
            .virtual-scroll-container { height: 350px; }
            .pagination-controls { 
                justify-content: flex-start;
                gap: 12px;
            }
            .pagination-controls label {
                font-size: 13px;
            }
            .virtual-item {
                padding: 16px;
                font-size: 13px;
            }
            .virtual-item-name {
                font-size: 14px;
                margin-bottom: 8px;
            }
            .virtual-item-details {
                font-size: 12px;
                gap: 5px;
            }
            .virtual-item-details div {
                padding: 2px 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }
        
        /* 響應式設計 - 手機版佈局優化 */
        @media (max-width: 768px) {
            .header {
                padding: 15px 10px;
                text-align: center;
            }
            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }
            .header p {
                font-size: 0.9rem;
                margin-bottom: 12px;
            }
            .refresh-btn {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            /* 主要佈局 */
            .dashboard {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 10px;
            }
            
            /* 卡片樣式 */
            .card {
                padding: 15px;
                border-radius: 12px;
            }
            .card h3 {
                font-size: 1.1rem;
                margin-bottom: 12px;
            }
            
            /* 健康度分數 */
            .health-score {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .health-circle {
                width: 70px;
                height: 70px;
                font-size: 16px;
            }
            .health-title {
                font-size: 1.1rem;
            }
            .health-metric {
                padding: 6px 12px;
                margin-bottom: 6px;
            }
            
            /* 服務項目 */
            .service-item {
                padding: 12px;
                border-radius: 8px;
            }
            .service-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .service-name {
                font-size: 14px;
                font-weight: 600;
            }
            .service-pid {
                font-size: 12px;
            }
            .service-metrics {
                gap: 8px;
                margin-top: 8px;
            }
            .metric {
                padding: 4px 8px;
                font-size: 12px;
            }
            .metric-label {
                font-size: 11px;
            }
            .metric-value {
                font-size: 12px;
                font-weight: 600;
            }
            
            /* 分頁控制 */
            .pagination-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            .pagination-controls label {
                justify-content: space-between;
            }
            .page-info {
                text-align: center;
            }
            
            /* 虛擬滾動容器 */
            .virtual-scroll-container {
                height: 400px;
            }
            
            /* 日誌項目 */
            .log-item {
                padding: 10px;
                font-size: 12px;
            }
            
            /* 圖表 */
            .lazy-chart {
                height: 200px;
            }
            .chart-placeholder {
                font-size: 14px;
                padding: 40px 20px;
            }
        }
        
        /* 響應式設計 - 平板電腦適配 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                padding: 15px;
            }
            
            .card {
                padding: 18px;
            }
            
            .health-score {
                gap: 18px;
            }
            .health-circle {
                width: 75px;
                height: 75px;
                font-size: 18px;
            }
            
            .service-item {
                padding: 14px;
            }
            
            .virtual-scroll-container {
                height: 450px;
            }
            
            .lazy-chart {
                height: 250px;
            }
        }
        
        /* 響應式設計 - 不同解析度下的文字大小調整 */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }
            .header p {
                font-size: 0.8rem;
            }
            
            .card h3 {
                font-size: 1rem;
            }
            
            .health-title {
                font-size: 1rem;
            }
            .health-metric {
                font-size: 13px;
            }
            
            .service-name {
                font-size: 13px;
            }
            .service-pid {
                font-size: 11px;
            }
            .metric {
                font-size: 11px;
            }
            
            .log-item {
                font-size: 11px;
            }
        }
        
        /* 高解析度螢幕優化 */
        @media (min-width: 1440px) {
            .dashboard {
                grid-template-columns: repeat(4, 1fr);
                max-width: 1600px;
                margin: 0 auto;
            }
            
            .card {
                padding: 25px;
            }
            
            .health-circle {
                width: 90px;
                height: 90px;
                font-size: 22px;
            }
            
            .service-item {
                padding: 18px;
            }
            
            .virtual-scroll-container {
                height: 600px;
            }
        }
        
        /* 互動性增強 - 服務詳細資訊模態框 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            color: var(--text-color);
            border: 1px solid var(--card-border);
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--metric-hover);
            color: var(--text-color);
        }
        
        .service-detail-section {
            margin-bottom: 20px;
        }
        
        .service-detail-section h4 {
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .service-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .service-detail-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .service-detail-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 4px;
        }
        
        .service-detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            word-break: break-all;
        }
        
        .service-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .service-action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .service-action-btn.primary {
            background: #3498db;
            color: white;
        }
        
        .service-action-btn.primary:hover {
            background: #2980b9;
        }
        
        .service-action-btn.danger {
            background: #e74c3c;
            color: white;
        }
        
        .service-action-btn.danger:hover {
            background: #c0392b;
        }
        
        .service-action-btn.warning {
            background: #f39c12;
            color: white;
        }
        
        .service-action-btn.warning:hover {
            background: #e67e22;
        }
        
        /* 搜尋/篩選功能 */
        .search-filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .clear-filters-btn {
            padding: 10px 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        
        .clear-filters-btn:hover {
            background: #5a6268;
        }
        
        .search-results-info {
            margin-bottom: 15px;
            padding: 8px 15px;
            background: #e3f2fd;
            border-radius: 8px;
            font-size: 14px;
            color: #1976d2;
        }
        
        /* 服務狀態即時通知 */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            pointer-events: none;
        }
        
        .notification {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #3498db;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            pointer-events: auto;
            max-width: 300px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            border-left-color: #27ae60;
        }
        
        .notification.warning {
            border-left-color: #f39c12;
        }
        
        .notification.error {
            border-left-color: #e74c3c;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .notification-message {
            font-size: 14px;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .notification-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6c757d;
            padding: 2px;
        }
        
        .notification-close:hover {
            color: #495057;
        }
        
        /* 服務項目點擊效果 */
        .service-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .service-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .service-item:active {
            transform: translateY(0);
        }
        
        /* 載入狀態指示器 */
        .loading-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Discord 模態框樣式 */
        .modal-body {
            padding: 20px 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            background: var(--metric-bg);
            color: var(--text-color);
            transition: border-color 0.3s ease;
        }
        
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .form-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--accent-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
        }
        
        .btn-secondary {
            background: var(--border-color);
            color: var(--text-color);
        }
        
        .btn-secondary:hover {
            background: var(--metric-border);
        }
        
        /* 排程設定樣式 */
        .schedule-section {
            margin-bottom: 30px;
        }
        
        .schedule-section h4 {
            margin-bottom: 15px;
            color: var(--text-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="time"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--metric-bg);
            color: var(--text-color);
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 8px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            color: var(--text-color);
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 6px;
        }
        
        .schedule-item {
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--metric-bg);
        }
        
        .schedule-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .schedule-item-name {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .schedule-item-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .schedule-item-status.active {
            background: #27ae60;
            color: white;
        }
        
        .schedule-item-status.paused {
            background: #f39c12;
            color: white;
        }
        
        .schedule-item-status.inactive {
            background: #95a5a6;
            color: white;
        }
        
        .schedule-item-details {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 10px;
        }
        
        .schedule-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .schedule-item-actions button {
            padding: 4px 8px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .btn-execute {
            background: var(--accent-color);
            color: white;
        }
        
        .btn-execute:hover {
            background: var(--accent-hover);
        }
        
        .btn-pause {
            background: #f39c12;
            color: white;
        }
        
        .btn-pause:hover {
            background: #e67e22;
        }
        
        .btn-resume {
            background: #27ae60;
            color: white;
        }
        
        .btn-resume:hover {
            background: #229954;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c0392b;
        }
        
        /* 響應式調整 */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .service-detail-grid {
                grid-template-columns: 1fr;
            }
            
            .service-actions {
                flex-direction: column;
            }
            
            .search-filter-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input {
                min-width: auto;
            }
            
            .notification-container {
                right: 10px;
                left: 10px;
            }
            
            .notification {
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>🖥️ MCP 監控系統儀表板 - 優化版</h1>
            <p>高性能即時系統監控 | 虛擬滾動 | 懶載入</p>
        </div>
        <div class="header-controls">
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">🌙</span>
                <span id="theme-text">深色模式</span>
            </button>
            <button class="refresh-btn" onclick="refreshAll()">🔄 重新整理</button>
        </div>
    </div>
    
    <div class="dashboard">
        <div class="card">
            <h3>📊 系統資源</h3>
            <div id="system-info" class="loading">載入中...</div>
            <div id="system-chart" class="lazy-chart" data-chart="system">
                <div class="chart-placeholder">點擊載入系統資源圖表</div>
            </div>
        </div>
        
        <div class="card">
            <h3>⚙️ 進程監控</h3>
            <div id="process-info" class="loading">載入中...</div>
            <div id="process-chart" class="lazy-chart" data-chart="process">
                <div class="chart-placeholder">點擊載入進程統計圖表</div>
            </div>
        </div>
        
        <div class="card">
            <h3>🌐 網路狀態</h3>
            <div id="network-info" class="loading">載入中...</div>
        </div>
        
        <div class="card">
            <h3>📁 檔案系統</h3>
            <div id="filesystem-info" class="loading">載入中...</div>
        </div>
        
        <div class="card">
            <h3>❤️ 系統健康度</h3>
            <div id="health-info" class="loading">載入中...</div>
            <div id="health-chart" class="lazy-chart" data-chart="health">
                <div class="chart-placeholder">點擊載入健康度趨勢圖表</div>
            </div>
        </div>
        
        <div class="card">
            <h3>🤖 Discord 監控</h3>
            <div id="discord-info" class="loading">載入中...</div>
            <div class="discord-controls" style="margin-top: 15px;">
                <button class="refresh-btn" onclick="sendDiscordReport()" style="font-size: 12px; padding: 6px 12px; margin-right: 10px;">
                    📤 發送報告
                </button>
                <button class="refresh-btn" onclick="showDiscordMessageModal()" style="font-size: 12px; padding: 6px 12px; margin-right: 10px;">
                    💬 發送訊息
                </button>
                <button class="refresh-btn" onclick="showScheduleModal()" style="font-size: 12px; padding: 6px 12px;">
                    📅 排程設定
                </button>
            </div>
        </div>
        
        <div class="card">
            <h3>📅 排程概覽</h3>
            <div id="schedule-overview" class="loading">載入中...</div>
        </div>

        <div class="card">
            <h3>🚨 即時警報</h3>
            <div id="alerts-info" class="loading">載入中...</div>
            <div class="alert-controls" style="margin-top: 15px;">
                <button class="refresh-btn" onclick="showThresholdSettings()" style="font-size: 12px; padding: 6px 12px;">
                    ⚙️ 閾值設定
                </button>
            </div>
        </div>
        
        <div class="card" style="grid-column: 1 / -1;">
            <h3>📋 即時日誌監控</h3>
            <div class="log-controls" style="margin-bottom: 15px;">
                <select id="log-level-filter" onchange="updateLogs()">
                    <option value="">所有級別</option>
                    <option value="ERROR">錯誤</option>
                    <option value="WARNING">警告</option>
                    <option value="INFO">資訊</option>
                    <option value="DEBUG">除錯</option>
                </select>
                <select id="log-type-filter" onchange="updateLogs()">
                    <option value="">所有類型</option>
                    <option value="system">系統</option>
                    <option value="auth">認證</option>
                    <option value="kernel">核心</option>
                    <option value="mail">郵件</option>
                </select>
                <button class="refresh-btn" onclick="updateLogs()">🔄 重新整理</button>
            </div>
            <div id="logs-container" class="virtual-scroll-container" style="height: 300px;">
                <div id="logs-content" class="virtual-scroll-content">
                    <div class="loading">載入日誌...</div>
                </div>
            </div>
        </div>
        
        <div class="card" style="grid-column: 1 / -1;">
            <h3>🔧 服務監控與控制</h3>
            
            <!-- 搜尋/篩選功能 -->
            <div class="search-filter-bar">
                <input type="text" id="service-search" class="search-input" placeholder="🔍 搜尋服務名稱、PID或命令..." onkeyup="handleServiceSearch()">
                <select id="status-filter" class="filter-select" onchange="handleStatusFilter()">
                    <option value="">所有狀態</option>
                    <option value="running">運行中</option>
                    <option value="sleeping">休眠中</option>
                    <option value="stopped">已停止</option>
                    <option value="zombie">殭屍進程</option>
                </select>
                <select id="cpu-filter" class="filter-select" onchange="handleCpuFilter()">
                    <option value="">CPU 使用率</option>
                    <option value="high">高 (>10%)</option>
                    <option value="medium">中 (1-10%)</option>
                    <option value="low">低 (<1%)</option>
                </select>
                <select id="memory-filter" class="filter-select" onchange="handleMemoryFilter()">
                    <option value="">記憶體使用率</option>
                    <option value="high">高 (>5%)</option>
                    <option value="medium">中 (1-5%)</option>
                    <option value="low">低 (<1%)</option>
                </select>
                <button class="clear-filters-btn" onclick="clearAllFilters()">清除篩選</button>
            </div>
            
            <div id="search-results-info" class="search-results-info" style="display: none;"></div>
            
            <div class="pagination-controls">
                <label>
                    排序: 
                    <select id="sort-select" onchange="resetPagination()">
                        <option value="cpu">CPU 使用率</option>
                        <option value="memory">記憶體使用率</option>
                        <option value="name">服務名稱</option>
                        <option value="pid">進程 ID</option>
                    </select>
                </label>
                <label>
                    <input type="checkbox" id="desc-order" onchange="resetPagination()" checked> 降序
                </label>
                <label>
                    <input type="checkbox" id="hide-idle" onchange="resetPagination()"> 隱藏閒置
                </label>
                <div class="page-info" id="page-info">載入中...</div>
            </div>
            <div id="services-virtual-container" class="virtual-scroll-container">
                <div id="services-virtual-content" class="virtual-scroll-content">
                    <div class="loading">載入服務數據...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 閾值設定模態對話框 -->
    <div id="threshold-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ 警報閾值設定</h3>
                <span class="close" onclick="closeThresholdModal()">&times;</span>
            </div>
            <div id="threshold-form">
                <div class="threshold-input">
                    <label>CPU 警告閾值 (%):</label>
                    <input type="number" id="cpu-warning" min="0" max="100" value="70">
                </div>
                <div class="threshold-input">
                    <label>CPU 嚴重閾值 (%):</label>
                    <input type="number" id="cpu-critical" min="0" max="100" value="85">
                </div>
                <div class="threshold-input">
                    <label>記憶體警告閾值 (%):</label>
                    <input type="number" id="memory-warning" min="0" max="100" value="80">
                </div>
                <div class="threshold-input">
                    <label>記憶體嚴重閾值 (%):</label>
                    <input type="number" id="memory-critical" min="0" max="100" value="90">
                </div>
                <div class="threshold-input">
                    <label>磁碟警告閾值 (%):</label>
                    <input type="number" id="disk-warning" min="0" max="100" value="85">
                </div>
                <div class="threshold-input">
                    <label>磁碟嚴重閾值 (%):</label>
                    <input type="number" id="disk-critical" min="0" max="100" value="95">
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="refresh-btn" onclick="saveThresholds()">💾 儲存設定</button>
                    <button class="refresh-btn" onclick="closeThresholdModal()" style="background: #6c757d; margin-left: 10px;">❌ 取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark Mode 主題切換功能
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
            
            // 重新載入已載入的圖表以應用新主題
            if (window.lazyChartManager) {
                window.lazyChartManager.reloadChartsForTheme();
            }
        }
        
        function updateThemeButton(theme) {
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (theme === 'dark') {
                themeIcon.textContent = '☀️';
                themeText.textContent = '淺色模式';
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = '深色模式';
            }
        }
        
        // 頁面載入時初始化主題
        document.addEventListener('DOMContentLoaded', initTheme);
        
        // 虛擬滾動實現
        class VirtualScrollList {
            constructor(container, options = {}) {
                this.container = container;
                this.content = container.querySelector('.virtual-scroll-content');
                this.itemHeight = options.itemHeight || 110;
                this.bufferSize = options.bufferSize || 3;
                this.data = [];
                this.visibleStart = 0;
                this.visibleEnd = 0;
                this.renderedItems = new Map();
                
                this.container.addEventListener('scroll', this.handleScroll.bind(this));
                this.render = this.render.bind(this);
            }
            
            setData(data) {
                this.data = data;
                this.content.style.height = (data.length * this.itemHeight) + 'px';
                
                // 清除載入狀態和所有內容
                this.content.className = 'virtual-scroll-content';
                this.content.innerHTML = ''; // 完全清空內容
                
                // 清除所有現有項目
                this.renderedItems.forEach(element => element.remove());
                this.renderedItems.clear();
                this.render();
            }
            
            handleScroll() {
                requestAnimationFrame(this.render);
            }
            
            render() {
                const containerHeight = this.container.clientHeight;
                const scrollTop = this.container.scrollTop;
                
                const startIndex = Math.floor(scrollTop / this.itemHeight);
                const endIndex = Math.min(
                    startIndex + Math.ceil(containerHeight / this.itemHeight) + this.bufferSize,
                    this.data.length
                );
                
                this.visibleStart = Math.max(0, startIndex - this.bufferSize);
                this.visibleEnd = endIndex;
                
                // 移除不可見的項目
                for (let [index, element] of this.renderedItems) {
                    if (index < this.visibleStart || index >= this.visibleEnd) {
                        element.remove();
                        this.renderedItems.delete(index);
                    }
                }
                
                // 添加可見的項目
                for (let i = this.visibleStart; i < this.visibleEnd; i++) {
                    if (!this.renderedItems.has(i) && this.data[i]) {
                        const element = this.createItem(this.data[i], i);
                        element.style.position = 'absolute';
                        element.style.top = (i * this.itemHeight) + 'px';
                        element.style.left = '0';
                        element.style.right = '0';
                        element.style.width = 'calc(100% - 2px)';
                        element.style.height = this.itemHeight + 'px';
                        element.style.zIndex = '1';
                        
                        this.content.appendChild(element);
                        this.renderedItems.set(i, element);
                    }
                }
            }
            
            createItem(data, index) {
                const div = document.createElement('div');
                div.className = 'virtual-item';
                div.innerHTML = `
                    <div class="virtual-item-left">
                        <div class="virtual-item-name">${data.name}</div>
                        <div class="virtual-item-details">
                            <div>進程 ID: ${data.pid}</div>
                            <div>CPU 使用率: ${data.cpu_percent.toFixed(1)}%</div>
                            <div>記憶體使用率: ${data.memory_percent.toFixed(1)}%</div>
                        </div>
                    </div>
                    <div class="virtual-item-right">
                        <div class="memory-bar" style="width: 70px; height: 10px; background: #eee; border-radius: 5px; margin-bottom: 8px;">
                            <div style="width: ${Math.min(data.memory_percent, 100)}%; height: 100%; background: ${data.memory_percent > 80 ? '#e74c3c' : data.memory_percent > 50 ? '#f39c12' : '#27ae60'}; border-radius: 5px;"></div>
                        </div>
                        <div style="font-size: 12px; color: #6c757d; text-align: center;">${data.memory_percent.toFixed(1)}%</div>
                    </div>
                `;
                return div;
            }
        }
        
        // 懶載入圖表管理
        class LazyChartManager {
            constructor() {
                this.charts = new Map();
                this.loadedCharts = new Set();
                this.initializeLazyCharts();
            }
            
            initializeLazyCharts() {
                document.querySelectorAll('.lazy-chart').forEach(chart => {
                    chart.addEventListener('click', () => this.loadChart(chart.dataset.chart));
                });
            }
            
            async loadChart(chartType) {
                if (this.loadedCharts.has(chartType)) return;
                
                const chartContainer = document.querySelector(`[data-chart="${chartType}"]`);
                chartContainer.innerHTML = '<div class="loading">載入圖表中...</div>';
                
                try {
                    // 動態載入圖表庫（如果還沒載入）
                    if (!window.Chart) {
                        await this.loadChartLibrary();
                    }
                    
                    // 根據圖表類型載入對應數據和創建圖表
                    const data = await this.fetchChartData(chartType);
                    const canvas = document.createElement('canvas');
                    canvas.style.maxHeight = '200px';
                    
                    chartContainer.innerHTML = '';
                    chartContainer.appendChild(canvas);
                    
                    this.createChart(canvas, chartType, data);
                    this.loadedCharts.add(chartType);
                    
                } catch (error) {
                    chartContainer.innerHTML = `<div style="color: #e74c3c;">圖表載入失敗: ${error.message}</div>`;
                }
            }
            
            async loadChartLibrary() {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            
            async fetchChartData(chartType) {
                const endpoints = {
                    system: '/api/system',
                    process: '/api/processes',
                    network: '/api/network',
                    health: '/api/trends?type=health'
                };
                
                const response = await fetch(endpoints[chartType]);
                return await response.json();
            }
            
            createChart(canvas, chartType, data) {
                // 檢測當前主題
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                
                // 主題相關的顏色配置
                const colors = {
                    light: {
                        textColor: '#2c3e50',
                        gridColor: 'rgba(0, 0, 0, 0.1)',
                        backgroundColor: 'rgba(255, 255, 255, 0.8)',
                        primary: '#3498db',
                        success: '#27ae60',
                        warning: '#f39c12',
                        danger: '#e74c3c',
                        secondary: '#95a5a6',
                        info: '#17a2b8'
                    },
                    dark: {
                        textColor: '#e8eaed',
                        gridColor: 'rgba(255, 255, 255, 0.1)',
                        backgroundColor: 'rgba(30, 30, 30, 0.8)',
                        primary: '#60a5fa',
                        success: '#34d399',
                        warning: '#fbbf24',
                        danger: '#f87171',
                        secondary: '#6b7280',
                        info: '#06b6d4'
                    }
                };
                
                const theme = isDarkMode ? colors.dark : colors.light;
                
                const configs = {
                    system: {
                        type: 'doughnut',
                        data: {
                            labels: ['已使用', '可用'],
                            datasets: [{
                                data: [data.cpu_percent || 0, 100 - (data.cpu_percent || 0)],
                                backgroundColor: [theme.danger, theme.secondary]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: { 
                                    display: true, 
                                    text: 'CPU 使用率分布',
                                    color: theme.textColor
                                },
                                legend: {
                                    labels: {
                                        color: theme.textColor
                                    }
                                }
                            }
                        }
                    },
                    process: {
                        type: 'bar',
                        data: {
                            labels: ['執行中', '休眠中', '殭屍進程'],
                            datasets: [{
                                data: [
                                    data.running_processes || 0,
                                    data.sleeping_processes || 0,
                                    data.zombie_processes || 0
                                ],
                                backgroundColor: [theme.success, theme.primary, theme.danger]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: { 
                                    display: true, 
                                    text: '進程狀態分布',
                                    color: theme.textColor
                                },
                                legend: { display: false }
                            },
                            scales: {
                                x: {
                                    ticks: { color: theme.textColor },
                                    grid: { color: theme.gridColor }
                                },
                                y: {
                                    ticks: { color: theme.textColor },
                                    grid: { color: theme.gridColor }
                                }
                            }
                        }
                    },
                    health: {
                        type: 'line',
                        data: {
                            labels: data.trends?.map(item => {
                                const date = new Date(item.timestamp);
                                return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                            }) || [],
                            datasets: [{
                                label: '整體健康度',
                                data: data.trends?.map(item => item.overall_score) || [],
                                borderColor: theme.primary,
                                backgroundColor: theme.primary.includes('#') ? theme.primary + '20' : theme.primary.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                                fill: true,
                                tension: 0.4
                            }, {
                                label: 'CPU 評分',
                                data: data.trends?.map(item => item.cpu_score) || [],
                                borderColor: theme.danger,
                                backgroundColor: theme.danger.includes('#') ? theme.danger + '20' : theme.danger.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                                fill: false,
                                tension: 0.4
                            }, {
                                label: '記憶體評分',
                                data: data.trends?.map(item => item.memory_score) || [],
                                borderColor: theme.success,
                                backgroundColor: theme.success.includes('#') ? theme.success + '20' : theme.success.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                                fill: false,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: { 
                                    display: true, 
                                    text: '健康度趨勢 (最近24小時)',
                                    color: theme.textColor
                                },
                                legend: { 
                                    display: true, 
                                    position: 'top',
                                    labels: {
                                        color: theme.textColor
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: { 
                                        display: true, 
                                        text: '評分',
                                        color: theme.textColor
                                    },
                                    ticks: { color: theme.textColor },
                                    grid: { color: theme.gridColor }
                                },
                                x: {
                                    title: { 
                                        display: true, 
                                        text: '時間',
                                        color: theme.textColor
                                    },
                                    ticks: { color: theme.textColor },
                                    grid: { color: theme.gridColor }
                                }
                            }
                        }
                    }
                };
                
                new Chart(canvas, configs[chartType]);
            }
            
            // 重新載入已載入的圖表以應用新主題
            reloadChartsForTheme() {
                this.loadedCharts.forEach(chartType => {
                    const chartContainer = document.querySelector(`[data-chart="${chartType}"]`);
                    if (chartContainer) {
                        this.loadChart(chartType);
                    }
                });
            }
        }
        
        // 全局變量
        let virtualScrollList;
        let lazyChartManager;
        let currentPage = 1;
        let totalPages = 1;
        let pageSize = 50;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('services-virtual-container');
            virtualScrollList = new VirtualScrollList(container, { itemHeight: 110 });
            lazyChartManager = new LazyChartManager();
            window.lazyChartManager = lazyChartManager;
            
            // 設置排程表單處理器
            setupScheduleFormHandler();
            
            refreshAll();
            
            // 每30秒自動刷新
            setInterval(refreshAll, 30000);
        });
        
        // API 請求函數
        async function fetchData(endpoint, timeout = 10000) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                const response = await fetch(endpoint, {
                    headers: {
                        'Accept-Encoding': 'gzip, deflate'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // 處理 FastAPI 的回應格式
                if (result.success === true && result.data !== undefined) {
                    return result.data;
                } else if (result.success === false) {
                    return { error: result.message || '請求失敗' };
                } else {
                    // 兼容舊格式或直接返回資料
                    return result;
                }
            } catch (error) {
                console.error('Fetch error for', endpoint, ':', error);
                
                if (error.name === 'AbortError') {
                    return { error: '請求超時，請檢查服務是否正常運行' };
                }
                
                return { error: `無法連接到服務: ${error.message}` };
            }
        }
        
        // 更新函數
        // 新功能函數
        async function updateHealthInfo() {
            const container = document.getElementById('health-info');
            container.className = ''; // 移除loading class
            
            let data;
            try {
                data = await fetchData('/api/health', 5000);
                
                if (data.error) {
                    // 降級顯示：顯示基本訊息而不是錯誤
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 16px; margin-bottom: 10px;">⏳</div>
                            <div>健康度評分功能準備中...</div>
                            <small style="opacity: 0.7;">增強功能可能需要額外啟動時間</small>
                        </div>
                    `;
                    return;
                }
                
                // 確保 data 是有效的對象
                if (!data || typeof data !== 'object') {
                    throw new Error('無效的健康度數據');
                }
                
            } catch (error) {
                console.error('健康度功能錯誤:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        <div style="font-size: 16px; margin-bottom: 10px;">⚠️</div>
                        <div>健康度評分暫時無法使用</div>
                        <small style="opacity: 0.7;">錯誤: ${error.message}</small>
                    </div>
                `;
                return;
            }
            
            const overallScore = data.overall || 0;
            let healthClass = 'health-critical';
            let healthText = '危險';
            
            if (overallScore >= 80) {
                healthClass = 'health-excellent';
                healthText = '優秀';
            } else if (overallScore >= 60) {
                healthClass = 'health-good';
                healthText = '良好';
            } else if (overallScore >= 40) {
                healthClass = 'health-warning';
                healthText = '警告';
            }
            
            container.innerHTML = `
                <div class="health-score">
                    <div class="health-circle ${healthClass}">
                        ${overallScore.toFixed(0)}
                    </div>
                    <div class="health-details">
                        <div class="health-title">🎯 整體健康度: ${healthText}</div>
                        <div class="health-metric">
                            <span class="health-metric-label">🔥 CPU 評分:</span>
                            <span class="health-metric-value">${data.cpu?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div class="health-metric">
                            <span class="health-metric-label">🧠 記憶體評分:</span>
                            <span class="health-metric-value">${data.memory?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div class="health-metric">
                            <span class="health-metric-label">💾 磁碟評分:</span>
                            <span class="health-metric-value">${data.disk?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div class="health-metric">
                            <span class="health-metric-label">⚡ 進程評分:</span>
                            <span class="health-metric-value">${data.process?.toFixed(1) || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function updateAlertsInfo() {
            const container = document.getElementById('alerts-info');
            container.className = ''; // 移除loading class
            
            let data;
            try {
                data = await fetchData('/api/alerts', 5000);
                
                if (data.error) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 16px; margin-bottom: 10px;">⏳</div>
                            <div>警報系統準備中...</div>
                            <small style="opacity: 0.7;">增強功能可能需要額外啟動時間</small>
                        </div>
                    `;
                    return;
                }
                
                // 確保 data 是有效的對象
                if (!data || typeof data !== 'object') {
                    throw new Error('無效的警報數據');
                }
                
            } catch (error) {
                console.error('警報功能錯誤:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        <div style="font-size: 16px; margin-bottom: 10px;">⚠️</div>
                        <div>警報系統暫時無法使用</div>
                        <small style="opacity: 0.7;">錯誤: ${error.message}</small>
                    </div>
                `;
                return;
            }
            
            const currentAlerts = data.current_alerts || [];
            const alertCount = data.alert_count || 0;
            
            if (alertCount === 0) {
                container.innerHTML = `
                    <div style="color: #27ae60; text-align: center; padding: 20px;">
                        ✅ 系統運行正常<br>
                        <small>無活躍警報</small>
                    </div>
                `;
                return;
            }
            
            let alertsHtml = `<div style="margin-bottom: 10px; font-weight: 600;">活躍警報 (${alertCount})</div>`;
            
            currentAlerts.forEach(alert => {
                const alertClass = alert.severity === 'critical' ? 'alert-critical' : 'alert-warning';
                const timestamp = new Date(alert.timestamp).toLocaleTimeString();
                
                alertsHtml += `
                    <div class="alert-item ${alertClass}">
                        <div class="alert-title">${alert.title}</div>
                        <div>${alert.description}</div>
                        <div class="alert-time">${timestamp}</div>
                    </div>
                `;
            });
            
            container.innerHTML = alertsHtml;
        }
        
        let logsVirtualList;
        
        async function updateLogs() {
            const levelFilter = document.getElementById('log-level-filter').value;
            const typeFilter = document.getElementById('log-type-filter').value;
            const logsContent = document.getElementById('logs-content');
            
            // 移除loading class
            logsContent.className = 'virtual-scroll-content';
            
            const params = new URLSearchParams({
                action: 'recent',
                count: 100
            });
            
            if (levelFilter) params.append('level', levelFilter);
            if (typeFilter) params.append('type', typeFilter);
            
            let data;
            try {
                data = await fetchData(`/api/logs?${params}`, 5000);
                
                if (data.error) {
                    logsContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            <div style="font-size: 20px; margin-bottom: 15px;">⏳</div>
                            <div style="font-size: 16px; margin-bottom: 10px;">日誌監控系統準備中...</div>
                            <small style="opacity: 0.7;">增強功能可能需要額外啟動時間</small>
                        </div>
                    `;
                    return;
                }
                
                // 確保 data 是有效的對象
                if (!data || typeof data !== 'object') {
                    throw new Error('無效的日誌數據');
                }
                
            } catch (error) {
                console.error('日誌功能錯誤:', error);
                logsContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 20px; margin-bottom: 15px;">⚠️</div>
                        <div style="font-size: 16px;">日誌監控暫時無法使用</div>
                        <small style="opacity: 0.7;">錯誤: ${error.message}</small>
                    </div>
                `;
                return;
            }
            
            // 檢查是否有日誌數據
            const logs = data.logs || [];
            if (logs.length === 0) {
                logsContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 20px; margin-bottom: 15px;">📋</div>
                        <div style="font-size: 16px; margin-bottom: 10px;">暫無日誌數據</div>
                        <small style="opacity: 0.7;">
                            可能原因:<br/>
                            • 日誌文件為空<br/>
                            • 需要系統權限讀取日誌文件<br/>
                            • 日誌監控服務未啟動
                        </small>
                    </div>
                `;
                return;
            }
            
            if (!logsVirtualList) {
                const container = document.getElementById('logs-container');
                logsVirtualList = new VirtualScrollList(container, { 
                    itemHeight: 50,
                    createItem: (log, index) => createLogItem(log, index)
                });
            }
            
            logsVirtualList.setData(logs);
        }
        
        function createLogItem(log, index) {
            const div = document.createElement('div');
            div.className = `log-item log-${log.level.toLowerCase()}`;
            
            const timestamp = log.original_timestamp || new Date(log.timestamp).toLocaleTimeString();
            
            div.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-type">[${log.log_type}]</span>
                <span class="log-level">[${log.level}]</span>
                <span class="log-message">${log.message}</span>
            `;
            
            return div;
        }
        
        function showThresholdSettings() {
            document.getElementById('threshold-modal').style.display = 'block';
            loadCurrentThresholds();
        }
        
        function closeThresholdModal() {
            document.getElementById('threshold-modal').style.display = 'none';
        }
        
        async function loadCurrentThresholds() {
            try {
                const data = await fetchData('/api/thresholds');
                const thresholds = data.thresholds || {};
                
                document.getElementById('cpu-warning').value = thresholds.cpu_warning || 70;
                document.getElementById('cpu-critical').value = thresholds.cpu_critical || 85;
                document.getElementById('memory-warning').value = thresholds.memory_warning || 80;
                document.getElementById('memory-critical').value = thresholds.memory_critical || 90;
                document.getElementById('disk-warning').value = thresholds.disk_warning || 85;
                document.getElementById('disk-critical').value = thresholds.disk_critical || 95;
            } catch (error) {
                console.error('載入閾值設定失敗:', error);
            }
        }
        
        async function saveThresholds() {
            const thresholds = {
                cpu_warning: parseFloat(document.getElementById('cpu-warning').value),
                cpu_critical: parseFloat(document.getElementById('cpu-critical').value),
                memory_warning: parseFloat(document.getElementById('memory-warning').value),
                memory_critical: parseFloat(document.getElementById('memory-critical').value),
                disk_warning: parseFloat(document.getElementById('disk-warning').value),
                disk_critical: parseFloat(document.getElementById('disk-critical').value)
            };
            
            try {
                const response = await fetch('/api/thresholds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ thresholds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('閾值設定已儲存');
                    closeThresholdModal();
                } else {
                    alert('儲存失敗: ' + (result.error || result.message));
                }
            } catch (error) {
                alert('儲存失敗: ' + error.message);
            }
        }
        
        async function updateSystemInfo() {
            const container = document.getElementById('system-info');
            container.className = ''; // 移除loading class
            
            const data = await fetchData('/api/system');
            
            if (data.error) {
                container.innerHTML = `<div style="color: #e74c3c;">錯誤: ${data.error}</div>`;
                return;
            }
            
            container.innerHTML = `
                <div class="metric"><span class="metric-label">CPU 使用率:</span><span class="metric-value">${data.cpu_percent || 'N/A'}%</span></div>
                <div class="metric"><span class="metric-label">記憶體使用率:</span><span class="metric-value">${data.memory_percent || 'N/A'}%</span></div>
                <div class="metric"><span class="metric-label">磁碟使用率:</span><span class="metric-value">${data.disk_percent || 'N/A'}%</span></div>
                <div class="metric"><span class="metric-label">系統負載:</span><span class="metric-value">${data.load_avg || 'N/A'}</span></div>
            `;
        }
        
        async function updateProcessInfo() {
            const container = document.getElementById('process-info');
            container.className = ''; // 移除loading class
            
            const data = await fetchData('/api/processes');
            
            if (data.error) {
                container.innerHTML = `<div style="color: #e74c3c;">錯誤: ${data.error}</div>`;
                return;
            }
            
            container.innerHTML = `
                <div class="metric"><span class="metric-label">總進程數:</span><span class="metric-value">${data.total_processes || 'N/A'}</span></div>
                <div class="metric"><span class="metric-label">執行中:</span><span class="metric-value" style="color: #27ae60">${data.running_processes || 'N/A'}</span></div>
                <div class="metric"><span class="metric-label">休眠中:</span><span class="metric-value">${data.sleeping_processes || 'N/A'}</span></div>
                <div class="metric"><span class="metric-label">殭屍進程:</span><span class="metric-value" style="color: #e74c3c">${data.zombie_processes || 0}</span></div>
            `;
        }
        
        async function updateNetworkInfo() {
            const container = document.getElementById('network-info');
            container.className = ''; // 移除loading class
            
            const data = await fetchData('/api/network');
            
            if (data.error) {
                container.innerHTML = `<div style="color: #e74c3c;">錯誤: ${data.error}</div>`;
                return;
            }
            
            container.innerHTML = `
                <div class="metric"><span class="metric-label">已發送:</span><span class="metric-value">${formatBytes(data.bytes_sent || 0)}</span></div>
                <div class="metric"><span class="metric-label">已接收:</span><span class="metric-value">${formatBytes(data.bytes_recv || 0)}</span></div>
                <div class="metric"><span class="metric-label">網路介面:</span><span class="metric-value">${data.interface_count || 'N/A'}</span></div>
                <div class="metric"><span class="metric-label">活躍連線:</span><span class="metric-value">${data.connections || 'N/A'}</span></div>
            `;
        }
        
        async function updateFilesystemInfo() {
            const container = document.getElementById('filesystem-info');
            container.className = ''; // 移除loading class
            
            const data = await fetchData('/api/filesystem');
            
            if (data.error) {
                container.innerHTML = `<div style="color: #e74c3c;">錯誤: ${data.error}</div>`;
                return;
            }
            
            container.innerHTML = `
                <div class="metric"><span class="metric-label">監控路徑:</span><span class="metric-value">${data.monitored_paths || 'N/A'}</span></div>
                <div class="metric"><span class="metric-label">總空間:</span><span class="metric-value">${formatBytes(data.total_space || 0)}</span></div>
                <div class="metric"><span class="metric-label">可用空間:</span><span class="metric-value">${formatBytes(data.free_space || 0)}</span></div>
                <div class="metric"><span class="metric-label">使用率:</span><span class="metric-value">${data.usage_percent || 'N/A'}%</span></div>
            `;
        }
        
        async function updateServicesInfo() {
            const sortBy = document.getElementById('sort-select').value;
            const descOrder = document.getElementById('desc-order').checked;
            const hideIdle = document.getElementById('hide-idle').checked;
            
            const params = new URLSearchParams({
                sort: sortBy,
                desc: descOrder,
                hide_idle: hideIdle,
                page: currentPage,
                page_size: pageSize
            });
            
            let data;
            try {
                data = await fetchData(`/api/services/paginated?${params}`);
                
                if (data.error) {
                    const servicesContent = document.getElementById('services-virtual-content');
                    servicesContent.className = 'virtual-scroll-content'; // 移除loading class
                    servicesContent.innerHTML = 
                        `<div style="color: #e74c3c; padding: 20px;">錯誤: ${data.error}</div>`;
                    return;
                }
                
                // 確保 data 是有效的對象
                if (!data || typeof data !== 'object') {
                    throw new Error('無效的服務數據');
                }
                
            } catch (error) {
                console.error('更新服務信息失敗:', error);
                const servicesContent = document.getElementById('services-virtual-content');
                servicesContent.className = 'virtual-scroll-content'; // 移除loading class
                servicesContent.innerHTML = 
                    `<div style="color: #e74c3c; padding: 20px;">載入服務信息失敗: ${error.message}</div>`;
                return;
            }
            
            // 明確移除載入狀態
            const servicesContent = document.getElementById('services-virtual-content');
            servicesContent.className = 'virtual-scroll-content'; // 移除loading class
            
            // 更新虛擬滾動列表
            // 處理 FastAPI 的 PaginatedResponse 格式
            const services = Array.isArray(data) ? data : (data.services || []);
            virtualScrollList.setData(services);
            
            // 更新分頁信息
            totalPages = data.total_pages || 1;
            const totalCount = data.count || data.total_count || 0;
            document.getElementById('page-info').textContent = 
                `第 ${currentPage} 頁，共 ${totalPages} 頁 (總計 ${totalCount} 個服務)`;
        }
        
        function resetPagination() {
            currentPage = 1;
            updateServicesInfo();
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function updateDiscordInfo() {
            const container = document.getElementById('discord-info');
            container.className = '';
            
            const data = await fetchData('/api/discord/');
            
            if (data.error) {
                container.innerHTML = `<div style="color: #e74c3c;">錯誤: ${data.error}</div>`;
                return;
            }
            
            // data 已經是實際的數據，不需要再訪問 data.data
            const status = data.discord_status;
            const messages = data.recent_messages;
            
            let statusColor = '#e74c3c';
            let statusText = '未連接';
            
            if (status.status === 'connected') {
                statusColor = '#27ae60';
                statusText = '已連接';
            } else if (status.status === 'error') {
                statusColor = '#f39c12';
                statusText = '連接錯誤';
            }
            
            container.innerHTML = `
                <div class="metric">
                    <span class="metric-label">連接狀態:</span>
                    <span class="metric-value" style="color: ${statusColor};">
                        ${statusText}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">伺服器:</span>
                    <span class="metric-value">${status.guild_name || 'N/A'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">頻道:</span>
                    <span class="metric-value">${status.channel_name || 'N/A'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">最近訊息:</span>
                    <span class="metric-value">${messages.count || 0} 條</span>
                </div>
                ${status.last_sent_time ? `
                <div class="metric">
                    <span class="metric-label">最後發送:</span>
                    <span class="metric-value">${new Date(status.last_sent_time).toLocaleString()}</span>
                </div>
                ` : ''}
                ${status.error ? `
                <div class="metric">
                    <span class="metric-label">錯誤:</span>
                    <span class="metric-value" style="color: #e74c3c; font-size: 11px;">
                        ${status.error}
                    </span>
                </div>
                ` : ''}
            `;
        }
        
        async function sendDiscordReport() {
            try {
                const response = await fetch('/api/discord/send-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        format: 'detailed',
                        include_charts: false
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('成功', '系統報告已發送到 Discord', 'success');
                    updateDiscordInfo(); // 更新 Discord 狀態
                } else {
                    showNotification('錯誤', result.message || '發送失敗', 'error');
                }
            } catch (error) {
                showNotification('錯誤', `發送失敗: ${error.message}`, 'error');
            }
        }
        
        function showDiscordMessageModal() {
            const modal = document.getElementById('discord-message-modal');
            modal.classList.add('active');
            
            // 清空表單
            document.getElementById('discord-message-text').value = '';
            document.getElementById('discord-message-urgent').checked = false;
            
            // 聚焦到文本框
            setTimeout(() => {
                document.getElementById('discord-message-text').focus();
            }, 300);
        }
        
        function closeDiscordMessageModal(event) {
            const modal = document.getElementById('discord-message-modal');
            if (event && event.target !== modal) return;
            modal.classList.remove('active');
        }
        
        async function sendDiscordMessage() {
            const messageText = document.getElementById('discord-message-text').value.trim();
            const isUrgent = document.getElementById('discord-message-urgent').checked;
            
            if (!messageText) {
                showNotification('警告', '請輸入訊息內容', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/discord/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: messageText,
                        urgent: isUrgent
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('成功', '訊息已發送到 Discord', 'success');
                    closeDiscordMessageModal();
                    updateDiscordInfo(); // 更新 Discord 狀態
                } else {
                    showNotification('錯誤', result.message || '發送失敗', 'error');
                }
            } catch (error) {
                showNotification('錯誤', `發送失敗: ${error.message}`, 'error');
            }
        }
        
        // 排程管理相關函數
        async function updateScheduleOverview() {
            const container = document.getElementById('schedule-overview');
            container.className = '';
            
            try {
                const data = await fetchData('/api/schedule/status/overview');
                
                if (data.error) {
                    container.innerHTML = `<div style="color: #e74c3c;">錯誤: ${data.error}</div>`;
                    return;
                }
                
                container.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">總排程數:</span>
                        <span class="metric-value">${data.total_schedules}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">活動排程:</span>
                        <span class="metric-value" style="color: #27ae60;">${data.active_schedules}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">暫停排程:</span>
                        <span class="metric-value" style="color: #f39c12;">${data.paused_schedules}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">排程器狀態:</span>
                        <span class="metric-value" style="color: ${data.scheduler_running ? '#27ae60' : '#e74c3c'};">
                            ${data.scheduler_running ? '運行中' : '已停止'}
                        </span>
                    </div>
                    ${data.next_executions && data.next_executions.length > 0 ? `
                    <div class="metric">
                        <span class="metric-label">下次執行:</span>
                        <span class="metric-value" style="font-size: 12px;">
                            ${data.next_executions[0].schedule_name}<br>
                            <small>${new Date(data.next_executions[0].next_run).toLocaleString()}</small>
                        </span>
                    </div>
                    ` : ''}
                `;
            } catch (error) {
                container.innerHTML = `<div style="color: #e74c3c;">載入失敗: ${error.message}</div>`;
            }
        }
        
        function showScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            modal.classList.add('active');
            
            // 顯示排程列表，隱藏表單
            document.getElementById('schedule-list').style.display = 'block';
            document.getElementById('schedule-form').style.display = 'none';
            
            // 設置表單處理器
            setupScheduleFormHandler();
            
            // 載入排程列表
            loadSchedules();
        }
        
        function closeScheduleModal(event) {
            const modal = document.getElementById('schedule-modal');
            if (event && event.target !== modal) return;
            modal.classList.remove('active');
        }
        
        async function loadSchedules() {
            const container = document.getElementById('schedule-items');
            container.innerHTML = '<div class="loading">載入中...</div>';
            
            try {
                const data = await fetchData('/api/schedule/');
                
                if (data.error) {
                    container.innerHTML = `<div style="color: #e74c3c;">錯誤: ${data.error}</div>`;
                    return;
                }
                
                if (data.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-light);">尚無排程</div>';
                    return;
                }
                
                container.innerHTML = data.map(schedule => `
                    <div class="schedule-item">
                        <div class="schedule-item-header">
                            <span class="schedule-item-name">${schedule.name}</span>
                            <span class="schedule-item-status ${schedule.status}">${getStatusText(schedule.status)}</span>
                        </div>
                        <div class="schedule-item-details">
                            ${schedule.description || '無描述'}<br>
                            類型: ${getTypeText(schedule.type)} | 時間: ${schedule.time}
                            ${schedule.next_run ? `<br>下次執行: ${new Date(schedule.next_run).toLocaleString()}` : ''}
                            ${schedule.last_run ? `<br>上次執行: ${new Date(schedule.last_run).toLocaleString()}` : ''}
                        </div>
                        <div class="schedule-item-actions">
                            <button class="btn-execute" onclick="executeSchedule('${schedule.id}')">▶️ 執行</button>
                            ${schedule.status === 'active' ? 
                                `<button class="btn-pause" onclick="pauseSchedule('${schedule.id}')">⏸️ 暫停</button>` :
                                `<button class="btn-resume" onclick="resumeSchedule('${schedule.id}')">▶️ 恢復</button>`
                            }
                            <button class="btn-delete" onclick="deleteSchedule('${schedule.id}')">🗑️ 刪除</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div style="color: #e74c3c;">載入失敗: ${error.message}</div>`;
            }
        }
        
        function getStatusText(status) {
            const statusMap = {
                'active': '活動',
                'paused': '暫停',
                'inactive': '停用'
            };
            return statusMap[status] || status;
        }
        
        function getTypeText(type) {
            const typeMap = {
                'daily': '每日',
                'weekly': '每週',
                'hourly': '每小時'
            };
            return typeMap[type] || type;
        }
        
        function showCreateScheduleForm() {
            document.getElementById('schedule-list').style.display = 'none';
            document.getElementById('schedule-form').style.display = 'block';
            document.getElementById('schedule-form-title').textContent = '新增排程';
            
            // 清空表單
            document.getElementById('schedule-form-element').reset();
            
            // 設定預設值
            document.getElementById('schedule-time').value = '09:00';
            document.getElementById('include-system').checked = true;
            document.getElementById('include-process').checked = true;
            document.getElementById('include-network').checked = true;
            document.getElementById('include-alerts').checked = true;
            
            updateScheduleForm();
        }
        
        function updateScheduleForm() {
            const type = document.getElementById('schedule-type').value;
            const weekdaysGroup = document.getElementById('schedule-weekdays-group');
            const intervalGroup = document.getElementById('schedule-interval-group');
            
            // 隱藏所有特殊選項
            weekdaysGroup.style.display = 'none';
            intervalGroup.style.display = 'none';
            
            // 根據類型顯示相應選項
            if (type === 'weekly') {
                weekdaysGroup.style.display = 'block';
            } else if (type === 'hourly') {
                intervalGroup.style.display = 'block';
            }
        }
        
        function cancelScheduleForm() {
            document.getElementById('schedule-form').style.display = 'none';
            document.getElementById('schedule-list').style.display = 'block';
        }
        
        // 表單提交處理
        let formHandlerAttached = false;
        
        function setupScheduleFormHandler() {
            if (formHandlerAttached) return;
            
            const form = document.getElementById('schedule-form-element');
            if (!form) return;
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('排程表單提交開始');
                
                const formData = {
                name: document.getElementById('schedule-name').value,
                description: document.getElementById('schedule-description').value || null,
                type: document.getElementById('schedule-type').value,
                time: document.getElementById('schedule-time').value,
                include_system_info: document.getElementById('include-system').checked,
                include_process_info: document.getElementById('include-process').checked,
                include_network_info: document.getElementById('include-network').checked,
                include_alerts: document.getElementById('include-alerts').checked,
                custom_message: document.getElementById('schedule-custom-message').value || null
            };
            
            // 根據類型添加特殊字段
            if (formData.type === 'weekly') {
                const weekdays = [];
                document.querySelectorAll('#schedule-weekdays-group input[type="checkbox"]:checked').forEach(cb => {
                    weekdays.push(cb.value);
                });
                if (weekdays.length === 0) {
                    showNotification('錯誤', '請至少選擇一個執行日期', 'error');
                    return;
                }
                formData.weekdays = weekdays;
            } else if (formData.type === 'hourly') {
                const interval = parseInt(document.getElementById('schedule-interval').value);
                if (!interval || interval < 1 || interval > 168) {
                    showNotification('錯誤', '間隔時間必須在 1-168 小時之間', 'error');
                    return;
                }
                formData.interval_hours = interval;
            }
            
            console.log('發送排程數據:', formData);
            
            try {
                const response = await fetch('/api/schedule/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                console.log('排程建立回應:', result);
                
                if (result.success) {
                    showNotification('成功', '排程建立成功', 'success');
                    cancelScheduleForm();
                    loadSchedules();
                    updateScheduleOverview();
                } else {
                    showNotification('錯誤', result.message || '建立失敗', 'error');
                }
            } catch (error) {
                showNotification('錯誤', `建立失敗: ${error.message}`, 'error');
            }
        });
        
        formHandlerAttached = true;
        }
        
        async function executeSchedule(scheduleId) {
            try {
                const response = await fetch(`/api/schedule/${scheduleId}/execute`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('成功', '排程已開始執行', 'success');
                } else {
                    showNotification('錯誤', result.message || '執行失敗', 'error');
                }
            } catch (error) {
                showNotification('錯誤', `執行失敗: ${error.message}`, 'error');
            }
        }
        
        async function pauseSchedule(scheduleId) {
            try {
                const response = await fetch(`/api/schedule/${scheduleId}/pause`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('成功', '排程已暫停', 'success');
                    loadSchedules();
                    updateScheduleOverview();
                } else {
                    showNotification('錯誤', result.message || '暫停失敗', 'error');
                }
            } catch (error) {
                showNotification('錯誤', `暫停失敗: ${error.message}`, 'error');
            }
        }
        
        async function resumeSchedule(scheduleId) {
            try {
                const response = await fetch(`/api/schedule/${scheduleId}/resume`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('成功', '排程已恢復', 'success');
                    loadSchedules();
                    updateScheduleOverview();
                } else {
                    showNotification('錯誤', result.message || '恢復失敗', 'error');
                }
            } catch (error) {
                showNotification('錯誤', `恢復失敗: ${error.message}`, 'error');
            }
        }
        
        async function deleteSchedule(scheduleId) {
            if (!confirm('確定要刪除這個排程嗎？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/schedule/${scheduleId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('成功', '排程已刪除', 'success');
                    loadSchedules();
                    updateScheduleOverview();
                } else {
                    showNotification('錯誤', result.message || '刪除失敗', 'error');
                }
            } catch (error) {
                showNotification('錯誤', `刪除失敗: ${error.message}`, 'error');
            }
        }
        
        async function refreshAll() {
            console.log('刷新所有數據...');
            
            // 基本功能（必須成功）
            const basicUpdates = [
                updateSystemInfo(),
                updateProcessInfo(),
                updateNetworkInfo(),
                updateFilesystemInfo(),
                updateServicesInfo(),
                updateDiscordInfo(),
                updateScheduleOverview()
            ];
            
            // 增強功能（允許失敗）
            const enhancedUpdates = [
                updateHealthInfo().catch(e => {
                    console.log('健康度功能暫時無法使用:', e);
                    const container = document.getElementById('health-info');
                    if (container) {
                        container.className = '';
                        container.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #6c757d;">
                                <div style="font-size: 16px; margin-bottom: 10px;">⚠️</div>
                                <div>健康度功能暫時無法使用</div>
                                <small style="opacity: 0.7;">錯誤: ${e.message}</small>
                            </div>
                        `;
                    }
                }),
                updateAlertsInfo().catch(e => {
                    console.log('警報功能暫時無法使用:', e);
                    const container = document.getElementById('alerts-info');
                    if (container) {
                        container.className = '';
                        container.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #6c757d;">
                                <div style="font-size: 16px; margin-bottom: 10px;">⚠️</div>
                                <div>警報功能暫時無法使用</div>
                                <small style="opacity: 0.7;">錯誤: ${e.message}</small>
                            </div>
                        `;
                    }
                }),
                updateLogs().catch(e => {
                    console.log('日誌功能暫時無法使用:', e);
                    const logsContent = document.getElementById('logs-content');
                    if (logsContent) {
                        logsContent.className = 'virtual-scroll-content';
                        logsContent.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #6c757d;">
                                <div style="font-size: 20px; margin-bottom: 15px;">⚠️</div>
                                <div style="font-size: 16px; margin-bottom: 10px;">日誌監控暫時無法使用</div>
                                <small style="opacity: 0.7;">需要系統權限才能讀取日誌文件<br/>
                                錯誤: ${e.message}</small>
                            </div>
                        `;
                    }
                })
            ];
            
            // 並行執行，但分開處理
            await Promise.all([
                Promise.all(basicUpdates),
                Promise.allSettled(enhancedUpdates)
            ]);
            
            console.log('數據刷新完成');
        }
    </script>
    
    <!-- 服務詳細資訊模態框 -->
    <div id="service-modal" class="modal-overlay" onclick="closeServiceModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-service-name">服務詳細資訊</h3>
                <button class="modal-close" onclick="closeServiceModal()">&times;</button>
            </div>
            <div id="modal-service-content">
                <!-- 服務詳細資訊將在這裡動態載入 -->
            </div>
        </div>
    </div>

    <!-- Discord 訊息模態框 -->
    <div id="discord-message-modal" class="modal-overlay" onclick="closeDiscordMessageModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">💬 發送 Discord 訊息</h3>
                <button class="modal-close" onclick="closeDiscordMessageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="discord-message-text">訊息內容:</label>
                    <textarea id="discord-message-text" rows="4" placeholder="請輸入要發送到 Discord 的訊息..."></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="discord-message-urgent"> 緊急訊息
                    </label>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="sendDiscordMessage()">
                        📤 發送訊息
                    </button>
                    <button class="btn btn-secondary" onclick="closeDiscordMessageModal()">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 排程設定模態框 -->
    <div id="schedule-modal" class="modal-overlay" onclick="closeScheduleModal(event)">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">📅 Discord 報告排程設定</h3>
                <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 排程列表 -->
                <div id="schedule-list" class="schedule-section">
                    <h4>現有排程</h4>
                    <div id="schedule-items">
                        <div class="loading">載入中...</div>
                    </div>
                    <button class="btn btn-primary" onclick="showCreateScheduleForm()" style="margin-top: 10px;">
                        ➕ 新增排程
                    </button>
                </div>
                
                <!-- 新增/編輯排程表單 -->
                <div id="schedule-form" class="schedule-section" style="display: none;">
                    <h4 id="schedule-form-title">新增排程</h4>
                    <form id="schedule-form-element">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="schedule-name">排程名稱:</label>
                                <input type="text" id="schedule-name" required maxlength="100" placeholder="例如：每日系統報告">
                            </div>
                            <div class="form-group">
                                <label for="schedule-type">排程類型:</label>
                                <select id="schedule-type" onchange="updateScheduleForm()">
                                    <option value="daily">每日</option>
                                    <option value="weekly">每週</option>
                                    <option value="hourly">每小時</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="schedule-description">描述:</label>
                            <textarea id="schedule-description" rows="2" maxlength="500" placeholder="可選的描述..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="schedule-time">執行時間:</label>
                                <input type="time" id="schedule-time" required>
                            </div>
                            <div class="form-group" id="schedule-interval-group" style="display: none;">
                                <label for="schedule-interval">間隔時間（小時）:</label>
                                <input type="number" id="schedule-interval" min="1" max="168" placeholder="24">
                            </div>
                        </div>
                        
                        <div class="form-group" id="schedule-weekdays-group" style="display: none;">
                            <label>執行日期:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" value="monday"> 週一</label>
                                <label><input type="checkbox" value="tuesday"> 週二</label>
                                <label><input type="checkbox" value="wednesday"> 週三</label>
                                <label><input type="checkbox" value="thursday"> 週四</label>
                                <label><input type="checkbox" value="friday"> 週五</label>
                                <label><input type="checkbox" value="saturday"> 週六</label>
                                <label><input type="checkbox" value="sunday"> 週日</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>報告內容:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="include-system" checked> 系統資訊</label>
                                <label><input type="checkbox" id="include-process" checked> 進程資訊</label>
                                <label><input type="checkbox" id="include-network" checked> 網路資訊</label>
                                <label><input type="checkbox" id="include-alerts" checked> 警報資訊</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="schedule-custom-message">自訂訊息前綴:</label>
                            <textarea id="schedule-custom-message" rows="2" maxlength="1000" placeholder="可選的自訂訊息前綴..."></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                💾 儲存排程
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelScheduleForm()">
                                取消
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 通知容器 -->
    <div id="notification-container" class="notification-container"></div>
    
    <script>
        // 搜尋和篩選功能
        let searchFilters = {
            search: '',
            status: '',
            cpu: '',
            memory: ''
        };
        
        let filteredServices = [];
        let originalServices = [];
        
        function handleServiceSearch() {
            const searchValue = document.getElementById('service-search').value.toLowerCase();
            searchFilters.search = searchValue;
            applyFilters();
        }
        
        function handleStatusFilter() {
            const statusValue = document.getElementById('status-filter').value;
            searchFilters.status = statusValue;
            applyFilters();
        }
        
        function handleCpuFilter() {
            const cpuValue = document.getElementById('cpu-filter').value;
            searchFilters.cpu = cpuValue;
            applyFilters();
        }
        
        function handleMemoryFilter() {
            const memoryValue = document.getElementById('memory-filter').value;
            searchFilters.memory = memoryValue;
            applyFilters();
        }
        
        function clearAllFilters() {
            document.getElementById('service-search').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('cpu-filter').value = '';
            document.getElementById('memory-filter').value = '';
            
            searchFilters = {
                search: '',
                status: '',
                cpu: '',
                memory: ''
            };
            
            applyFilters();
        }
        
        function applyFilters() {
            if (!originalServices.length) {
                originalServices = virtualScrollList.data || [];
            }
            
            filteredServices = originalServices.filter(service => {
                // 文字搜尋
                if (searchFilters.search) {
                    const searchText = searchFilters.search;
                    const matchesSearch = (
                        service.name.toLowerCase().includes(searchText) ||
                        service.pid.toString().includes(searchText) ||
                        (service.cmdline && service.cmdline.toLowerCase().includes(searchText))
                    );
                    if (!matchesSearch) return false;
                }
                
                // 狀態篩選
                if (searchFilters.status) {
                    const status = service.status.toLowerCase();
                    if (searchFilters.status === 'running' && status !== 'running') return false;
                    if (searchFilters.status === 'sleeping' && status !== 'sleeping') return false;
                    if (searchFilters.status === 'stopped' && status !== 'stopped') return false;
                    if (searchFilters.status === 'zombie' && status !== 'zombie') return false;
                }
                
                // CPU 篩選
                if (searchFilters.cpu) {
                    const cpuPercent = service.cpu_percent || 0;
                    if (searchFilters.cpu === 'high' && cpuPercent <= 10) return false;
                    if (searchFilters.cpu === 'medium' && (cpuPercent <= 1 || cpuPercent > 10)) return false;
                    if (searchFilters.cpu === 'low' && cpuPercent >= 1) return false;
                }
                
                // 記憶體篩選
                if (searchFilters.memory) {
                    const memoryPercent = service.memory_percent || 0;
                    if (searchFilters.memory === 'high' && memoryPercent <= 5) return false;
                    if (searchFilters.memory === 'medium' && (memoryPercent <= 1 || memoryPercent > 5)) return false;
                    if (searchFilters.memory === 'low' && memoryPercent >= 1) return false;
                }
                
                return true;
            });
            
            // 更新搜尋結果資訊
            const resultsInfo = document.getElementById('search-results-info');
            const hasActiveFilters = Object.values(searchFilters).some(filter => filter !== '');
            
            if (hasActiveFilters) {
                resultsInfo.style.display = 'block';
                resultsInfo.textContent = `找到 ${filteredServices.length} 個符合條件的服務 (共 ${originalServices.length} 個)`;
            } else {
                resultsInfo.style.display = 'none';
            }
            
            // 更新虛擬滾動列表
            virtualScrollList.setData(filteredServices);
            
            // 重置分頁
            currentPage = 1;
            updatePaginationInfo();
        }
        
        function updatePaginationInfo() {
            const totalCount = filteredServices.length || originalServices.length;
            document.getElementById('page-info').textContent = 
                `第 ${currentPage} 頁，共 ${totalPages} 頁 (總計 ${totalCount} 個服務)`;
        }
        
        // 服務詳細資訊模態框
        async function showServiceDetails(serviceData) {
            const modal = document.getElementById('service-modal');
            const modalTitle = document.getElementById('modal-service-name');
            const modalContent = document.getElementById('modal-service-content');
            
            modalTitle.textContent = serviceData.name;
            modalContent.innerHTML = '<div class="loading-indicator"></div>';
            
            modal.classList.add('active');
            
            try {
                // 獲取詳細資訊
                const response = await fetch(`/api/services/control?action=info&pid=${serviceData.pid}`);
                const detailData = await response.json();
                
                if (detailData.service_info) {
                    const info = detailData.service_info;
                    const createTime = new Date(info.create_time * 1000);
                    
                    modalContent.innerHTML = `
                        <div class="service-detail-section">
                            <h4>基本資訊</h4>
                            <div class="service-detail-grid">
                                <div class="service-detail-item">
                                    <div class="service-detail-label">服務名稱</div>
                                    <div class="service-detail-value">${info.name}</div>
                                </div>
                                <div class="service-detail-item">
                                    <div class="service-detail-label">進程 ID</div>
                                    <div class="service-detail-value">${info.pid}</div>
                                </div>
                                <div class="service-detail-item">
                                    <div class="service-detail-label">狀態</div>
                                    <div class="service-detail-value">${info.status}</div>
                                </div>
                                <div class="service-detail-item">
                                    <div class="service-detail-label">建立時間</div>
                                    <div class="service-detail-value">${createTime.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="service-detail-section">
                            <h4>資源使用</h4>
                            <div class="service-detail-grid">
                                <div class="service-detail-item">
                                    <div class="service-detail-label">CPU 使用率</div>
                                    <div class="service-detail-value">${info.cpu_percent?.toFixed(2) || 0}%</div>
                                </div>
                                <div class="service-detail-item">
                                    <div class="service-detail-label">記憶體使用率</div>
                                    <div class="service-detail-value">${info.memory_percent?.toFixed(2) || 0}%</div>
                                </div>
                                <div class="service-detail-item">
                                    <div class="service-detail-label">工作目錄</div>
                                    <div class="service-detail-value">${info.cwd || 'N/A'}</div>
                                </div>
                                <div class="service-detail-item">
                                    <div class="service-detail-label">用戶</div>
                                    <div class="service-detail-value">${info.username || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="service-detail-section">
                            <h4>命令行</h4>
                            <div class="service-detail-item">
                                <div class="service-detail-label">完整命令</div>
                                <div class="service-detail-value">${info.cmdline || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <div class="service-actions">
                            <button class="service-action-btn warning" onclick="terminateService(${info.pid}, false)">
                                ⏹️ 正常終止
                            </button>
                            <button class="service-action-btn danger" onclick="terminateService(${info.pid}, true)">
                                🛑 強制終止
                            </button>
                            <button class="service-action-btn primary" onclick="refreshServiceDetails(${info.pid})">
                                🔄 重新整理
                            </button>
                        </div>
                    `;
                } else {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
                            <div>無法獲取服務詳細資訊</div>
                        </div>
                    `;
                }
            } catch (error) {
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
                        <div>載入失敗: ${error.message}</div>
                    </div>
                `;
            }
        }
        
        function closeServiceModal(event) {
            if (event && event.target !== event.currentTarget) return;
            
            const modal = document.getElementById('service-modal');
            modal.classList.remove('active');
        }
        
        async function terminateService(pid, force = false) {
            const action = force ? '強制終止' : '正常終止';
            
            if (!confirm(`確定要${action}進程 ${pid} 嗎？`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/services/control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'terminate',
                        pid: pid,
                        force: force
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('成功', result.message, 'success');
                    closeServiceModal();
                    // 重新載入服務列表
                    setTimeout(() => {
                        updateServicesInfo();
                    }, 1000);
                } else {
                    showNotification('錯誤', result.message, 'error');
                }
            } catch (error) {
                showNotification('錯誤', `操作失敗: ${error.message}`, 'error');
            }
        }
        
        async function refreshServiceDetails(pid) {
            const modalContent = document.getElementById('modal-service-content');
            modalContent.innerHTML = '<div class="loading-indicator"></div>';
            
            // 重新載入服務詳細資訊
            const serviceData = { pid: pid };
            setTimeout(() => {
                showServiceDetails(serviceData);
            }, 500);
        }
        
        // 通知系統
        function showNotification(title, message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
                <button class="notification-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            container.appendChild(notification);
            
            // 觸發顯示動畫
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // 自動移除
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }
        
        // 修改服務項目點擊事件
        function createServiceItem(service, index) {
            const div = document.createElement('div');
            div.className = 'service-item';
            div.onclick = () => showServiceDetails(service);
            
            const statusClass = service.status === 'running' ? 'status-running' : 
                               service.status === 'sleeping' ? 'status-sleeping' : 'status-stopped';
            
            div.innerHTML = `
                <div class="service-header">
                    <span class="service-name">${service.name}</span>
                    <span class="service-pid">PID: ${service.pid}</span>
                </div>
                <div class="service-metrics">
                    <div class="metric">
                        <span class="metric-label">狀態:</span>
                        <span class="metric-value ${statusClass}">${service.status}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">CPU:</span>
                        <span class="metric-value">${service.cpu_percent?.toFixed(1) || 0}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">記憶體:</span>
                        <span class="metric-value">${service.memory_percent?.toFixed(1) || 0}%</span>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        // 重寫 updateServicesInfo 函數以支援篩選
        const originalUpdateServicesInfo = updateServicesInfo;
        updateServicesInfo = async function() {
            await originalUpdateServicesInfo();
            
            // 保存原始數據
            if (virtualScrollList && virtualScrollList.data) {
                originalServices = [...virtualScrollList.data];
                
                // 如果有篩選條件，重新應用篩選
                const hasActiveFilters = Object.values(searchFilters).some(filter => filter !== '');
                if (hasActiveFilters) {
                    applyFilters();
                }
            }
        };
        
        // 服務狀態變化監控
        let previousServiceStates = {};
        
        function monitorServiceChanges() {
            if (!originalServices.length) return;
            
            originalServices.forEach(service => {
                const serviceKey = `${service.name}-${service.pid}`;
                const currentState = {
                    status: service.status,
                    cpu_percent: service.cpu_percent,
                    memory_percent: service.memory_percent
                };
                
                if (previousServiceStates[serviceKey]) {
                    const prevState = previousServiceStates[serviceKey];
                    
                    // 檢查狀態變化
                    if (prevState.status !== currentState.status) {
                        showNotification(
                            '服務狀態變化',
                            `${service.name} (PID: ${service.pid}) 狀態從 ${prevState.status} 變為 ${currentState.status}`,
                            currentState.status === 'running' ? 'success' : 'warning'
                        );
                    }
                    
                    // 檢查高 CPU 使用率
                    if (currentState.cpu_percent > 80 && prevState.cpu_percent <= 80) {
                        showNotification(
                            '高 CPU 使用率警告',
                            `${service.name} (PID: ${service.pid}) CPU 使用率達到 ${currentState.cpu_percent.toFixed(1)}%`,
                            'warning'
                        );
                    }
                    
                    // 檢查高記憶體使用率
                    if (currentState.memory_percent > 80 && prevState.memory_percent <= 80) {
                        showNotification(
                            '高記憶體使用率警告',
                            `${service.name} (PID: ${service.pid}) 記憶體使用率達到 ${currentState.memory_percent.toFixed(1)}%`,
                            'warning'
                        );
                    }
                }
                
                previousServiceStates[serviceKey] = currentState;
            });
        }
        
        // 定期監控服務狀態變化
        setInterval(monitorServiceChanges, 5000);
        
        // 鍵盤快捷鍵
        document.addEventListener('keydown', function(e) {
            // ESC 鍵關閉模態框
            if (e.key === 'Escape') {
                closeServiceModal();
            }
            
            // Ctrl+F 聚焦搜尋框
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('service-search').focus();
            }
        });
    </script>
</body>
</html>