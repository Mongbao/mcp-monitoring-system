<!DOCTYPE html>
<html>
<head>
    <title>æ¸¬è©¦å‰ç«¯å‡½æ•¸</title>
</head>
<body>
    <h1>æ¸¬è©¦ MCP å‰ç«¯å‡½æ•¸</h1>
    
    <div id="health-info" class="loading">å¥åº·åº¦è¼‰å…¥ä¸­...</div>
    <div id="alerts-info" class="loading">è­¦å ±è¼‰å…¥ä¸­...</div>
    
    <button onclick="testHealthInfo()">æ¸¬è©¦å¥åº·åº¦</button>
    <button onclick="testAlertsInfo()">æ¸¬è©¦è­¦å ±</button>
    <button onclick="testBothFunctions()">æ¸¬è©¦å…©å€‹å‡½æ•¸</button>
    
    <script>
        // API è«‹æ±‚å‡½æ•¸
        async function fetchData(endpoint, timeout = 10000) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                const response = await fetch(endpoint, {
                    headers: {
                        'Accept': 'application/json',
                        'Accept-Encoding': 'gzip, deflate'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('è«‹æ±‚è¶…æ™‚');
                }
                throw error;
            }
        }
        
        async function updateHealthInfo() {
            const container = document.getElementById('health-info');
            container.className = ''; // ç§»é™¤loading class
            
            try {
                const data = await fetchData('http://localhost:8003/api/health', 5000);
                
                if (data.error) {
                    // é™ç´šé¡¯ç¤ºï¼šé¡¯ç¤ºåŸºæœ¬è¨Šæ¯è€Œä¸æ˜¯éŒ¯èª¤
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 16px; margin-bottom: 10px;">â³</div>
                            <div>å¥åº·åº¦è©•åˆ†åŠŸèƒ½æº–å‚™ä¸­...</div>
                            <small style="opacity: 0.7;">å¢å¼·åŠŸèƒ½å¯èƒ½éœ€è¦é¡å¤–å•Ÿå‹•æ™‚é–“</small>
                        </div>
                    `;
                    return;
                }
                
                // ç¢ºä¿ data æ˜¯æœ‰æ•ˆçš„å°è±¡
                if (!data || typeof data !== 'object') {
                    throw new Error('ç„¡æ•ˆçš„å¥åº·åº¦æ•¸æ“š');
                }
                
            } catch (error) {
                console.error('å¥åº·åº¦åŠŸèƒ½éŒ¯èª¤:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        <div style="font-size: 16px; margin-bottom: 10px;">âš ï¸</div>
                        <div>å¥åº·åº¦è©•åˆ†æš«æ™‚ç„¡æ³•ä½¿ç”¨</div>
                        <small style="opacity: 0.7;">éŒ¯èª¤: ${error.message}</small>
                    </div>
                `;
                return;
            }
            
            const overallScore = data.overall || 0;
            let healthClass = 'health-critical';
            let healthText = 'å±éšª';
            
            if (overallScore >= 80) {
                healthClass = 'health-excellent';
                healthText = 'å„ªç§€';
            } else if (overallScore >= 60) {
                healthClass = 'health-good';
                healthText = 'è‰¯å¥½';
            } else if (overallScore >= 40) {
                healthClass = 'health-warning';
                healthText = 'è­¦å‘Š';
            }
            
            container.innerHTML = `
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #3498db, #5dade2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
                        ${overallScore.toFixed(0)}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 10px;">ğŸ¯ æ•´é«”å¥åº·åº¦: ${healthText}</div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>ğŸ”¥ CPU è©•åˆ†:</span>
                            <span style="font-weight: 700;">${data.cpu?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>ğŸ§  è¨˜æ†¶é«”è©•åˆ†:</span>
                            <span style="font-weight: 700;">${data.memory?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>ğŸ’¾ ç£ç¢Ÿè©•åˆ†:</span>
                            <span style="font-weight: 700;">${data.disk?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>âš¡ é€²ç¨‹è©•åˆ†:</span>
                            <span style="font-weight: 700;">${data.process?.toFixed(1) || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function updateAlertsInfo() {
            const container = document.getElementById('alerts-info');
            container.className = ''; // ç§»é™¤loading class
            
            try {
                const data = await fetchData('http://localhost:8003/api/alerts', 5000);
                
                if (data.error) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 16px; margin-bottom: 10px;">â³</div>
                            <div>è­¦å ±ç³»çµ±æº–å‚™ä¸­...</div>
                            <small style="opacity: 0.7;">å¢å¼·åŠŸèƒ½å¯èƒ½éœ€è¦é¡å¤–å•Ÿå‹•æ™‚é–“</small>
                        </div>
                    `;
                    return;
                }
                
                // ç¢ºä¿ data æ˜¯æœ‰æ•ˆçš„å°è±¡
                if (!data || typeof data !== 'object') {
                    throw new Error('ç„¡æ•ˆçš„è­¦å ±æ•¸æ“š');
                }
                
            } catch (error) {
                console.error('è­¦å ±åŠŸèƒ½éŒ¯èª¤:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        <div style="font-size: 16px; margin-bottom: 10px;">âš ï¸</div>
                        <div>è­¦å ±ç³»çµ±æš«æ™‚ç„¡æ³•ä½¿ç”¨</div>
                        <small style="opacity: 0.7;">éŒ¯èª¤: ${error.message}</small>
                    </div>
                `;
                return;
            }
            
            const currentAlerts = data.current_alerts || [];
            const alertCount = data.alert_count || 0;
            
            if (alertCount === 0) {
                container.innerHTML = `
                    <div style="color: #27ae60; text-align: center; padding: 20px;">
                        âœ… ç³»çµ±é‹è¡Œæ­£å¸¸<br>
                        <small>ç„¡æ´»èºè­¦å ±</small>
                    </div>
                `;
                return;
            }
            
            let alertsHtml = `<div style="margin-bottom: 10px; font-weight: 600;">æ´»èºè­¦å ± (${alertCount})</div>`;
            
            currentAlerts.forEach(alert => {
                const alertClass = alert.severity === 'critical' ? 'alert-critical' : 'alert-warning';
                const timestamp = new Date(alert.timestamp).toLocaleTimeString();
                
                alertsHtml += `
                    <div style="margin-bottom: 8px; padding: 8px; border-left: 4px solid ${alert.severity === 'critical' ? '#e74c3c' : '#f39c12'}; background: rgba(255,255,255,0.1);">
                        <div style="font-weight: 600;">${alert.title}</div>
                        <div>${alert.description}</div>
                        <div style="font-size: 12px; opacity: 0.8;">${timestamp}</div>
                    </div>
                `;
            });
            
            container.innerHTML = alertsHtml;
        }
        
        async function testHealthInfo() {
            console.log('æ¸¬è©¦å¥åº·åº¦åŠŸèƒ½...');
            await updateHealthInfo();
            console.log('å¥åº·åº¦åŠŸèƒ½æ¸¬è©¦å®Œæˆ');
        }
        
        async function testAlertsInfo() {
            console.log('æ¸¬è©¦è­¦å ±åŠŸèƒ½...');
            await updateAlertsInfo();
            console.log('è­¦å ±åŠŸèƒ½æ¸¬è©¦å®Œæˆ');
        }
        
        async function testBothFunctions() {
            console.log('æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½...');
            await Promise.all([
                updateHealthInfo().catch(e => console.error('å¥åº·åº¦éŒ¯èª¤:', e)),
                updateAlertsInfo().catch(e => console.error('è­¦å ±éŒ¯èª¤:', e))
            ]);
            console.log('æ‰€æœ‰åŠŸèƒ½æ¸¬è©¦å®Œæˆ');
        }
    </script>
</body>
</html>