<!DOCTYPE html>
<html>
<head>
    <title>測試前端函數</title>
</head>
<body>
    <h1>測試 MCP 前端函數</h1>
    
    <div id="health-info" class="loading">健康度載入中...</div>
    <div id="alerts-info" class="loading">警報載入中...</div>
    
    <button onclick="testHealthInfo()">測試健康度</button>
    <button onclick="testAlertsInfo()">測試警報</button>
    <button onclick="testBothFunctions()">測試兩個函數</button>
    
    <script>
        // API 請求函數
        async function fetchData(endpoint, timeout = 10000) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                const response = await fetch(endpoint, {
                    headers: {
                        'Accept': 'application/json',
                        'Accept-Encoding': 'gzip, deflate'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('請求超時');
                }
                throw error;
            }
        }
        
        async function updateHealthInfo() {
            const container = document.getElementById('health-info');
            container.className = ''; // 移除loading class
            
            try {
                const data = await fetchData('http://localhost:8003/api/health', 5000);
                
                if (data.error) {
                    // 降級顯示：顯示基本訊息而不是錯誤
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 16px; margin-bottom: 10px;">⏳</div>
                            <div>健康度評分功能準備中...</div>
                            <small style="opacity: 0.7;">增強功能可能需要額外啟動時間</small>
                        </div>
                    `;
                    return;
                }
                
                // 確保 data 是有效的對象
                if (!data || typeof data !== 'object') {
                    throw new Error('無效的健康度數據');
                }
                
            } catch (error) {
                console.error('健康度功能錯誤:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        <div style="font-size: 16px; margin-bottom: 10px;">⚠️</div>
                        <div>健康度評分暫時無法使用</div>
                        <small style="opacity: 0.7;">錯誤: ${error.message}</small>
                    </div>
                `;
                return;
            }
            
            const overallScore = data.overall || 0;
            let healthClass = 'health-critical';
            let healthText = '危險';
            
            if (overallScore >= 80) {
                healthClass = 'health-excellent';
                healthText = '優秀';
            } else if (overallScore >= 60) {
                healthClass = 'health-good';
                healthText = '良好';
            } else if (overallScore >= 40) {
                healthClass = 'health-warning';
                healthText = '警告';
            }
            
            container.innerHTML = `
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #3498db, #5dade2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
                        ${overallScore.toFixed(0)}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 10px;">🎯 整體健康度: ${healthText}</div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>🔥 CPU 評分:</span>
                            <span style="font-weight: 700;">${data.cpu?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>🧠 記憶體評分:</span>
                            <span style="font-weight: 700;">${data.memory?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>💾 磁碟評分:</span>
                            <span style="font-weight: 700;">${data.disk?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>⚡ 進程評分:</span>
                            <span style="font-weight: 700;">${data.process?.toFixed(1) || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function updateAlertsInfo() {
            const container = document.getElementById('alerts-info');
            container.className = ''; // 移除loading class
            
            try {
                const data = await fetchData('http://localhost:8003/api/alerts', 5000);
                
                if (data.error) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 16px; margin-bottom: 10px;">⏳</div>
                            <div>警報系統準備中...</div>
                            <small style="opacity: 0.7;">增強功能可能需要額外啟動時間</small>
                        </div>
                    `;
                    return;
                }
                
                // 確保 data 是有效的對象
                if (!data || typeof data !== 'object') {
                    throw new Error('無效的警報數據');
                }
                
            } catch (error) {
                console.error('警報功能錯誤:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        <div style="font-size: 16px; margin-bottom: 10px;">⚠️</div>
                        <div>警報系統暫時無法使用</div>
                        <small style="opacity: 0.7;">錯誤: ${error.message}</small>
                    </div>
                `;
                return;
            }
            
            const currentAlerts = data.current_alerts || [];
            const alertCount = data.alert_count || 0;
            
            if (alertCount === 0) {
                container.innerHTML = `
                    <div style="color: #27ae60; text-align: center; padding: 20px;">
                        ✅ 系統運行正常<br>
                        <small>無活躍警報</small>
                    </div>
                `;
                return;
            }
            
            let alertsHtml = `<div style="margin-bottom: 10px; font-weight: 600;">活躍警報 (${alertCount})</div>`;
            
            currentAlerts.forEach(alert => {
                const alertClass = alert.severity === 'critical' ? 'alert-critical' : 'alert-warning';
                const timestamp = new Date(alert.timestamp).toLocaleTimeString();
                
                alertsHtml += `
                    <div style="margin-bottom: 8px; padding: 8px; border-left: 4px solid ${alert.severity === 'critical' ? '#e74c3c' : '#f39c12'}; background: rgba(255,255,255,0.1);">
                        <div style="font-weight: 600;">${alert.title}</div>
                        <div>${alert.description}</div>
                        <div style="font-size: 12px; opacity: 0.8;">${timestamp}</div>
                    </div>
                `;
            });
            
            container.innerHTML = alertsHtml;
        }
        
        async function testHealthInfo() {
            console.log('測試健康度功能...');
            await updateHealthInfo();
            console.log('健康度功能測試完成');
        }
        
        async function testAlertsInfo() {
            console.log('測試警報功能...');
            await updateAlertsInfo();
            console.log('警報功能測試完成');
        }
        
        async function testBothFunctions() {
            console.log('測試所有功能...');
            await Promise.all([
                updateHealthInfo().catch(e => console.error('健康度錯誤:', e)),
                updateAlertsInfo().catch(e => console.error('警報錯誤:', e))
            ]);
            console.log('所有功能測試完成');
        }
    </script>
</body>
</html>